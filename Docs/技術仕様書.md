# 店舗不具合フォーム 技術仕様書

> **対象者:** エンジニア・技術管理者向け

---

## 1. システム概要

### 1.1 システム名
**店舗不具合報告フォーム管理システム**

### 1.2 目的
店舗からの不具合報告を効率的に収集するため、リージョン別の店舗選択を動的に管理する。BigQueryからマスターデータを取得し、Google Formsの選択肢を自動更新する。

---

## 2. 技術スタック

### 2.1 プラットフォーム

| 項目 | 技術 |
|------|------|
| 実行環境 | Google Apps Script (GAS) |
| ランタイム | V8 JavaScript Engine |
| ホスティング | Google Cloud (自動) |

### 2.2 Google Workspace サービス

| サービス | 用途 | API |
|---------|------|-----|
| Google Sheets | マスターデータ管理 | SpreadsheetApp |
| Google Forms | 不具合報告フォーム | FormApp |
| Google Drive | ファイルアクセス | DriveApp |

### 2.3 Google Cloud サービス

| サービス | 用途 | 接続方式 |
|---------|------|---------|
| BigQuery | データソース | BigQuery Advanced Service |
| Cloud IAM | 認証・認可 | OAuth 2.0 |

### 2.4 外部データソース

| テーブル | スキーマ | 用途 |
|---------|---------|------|
| `exment.SHOPS` | BigQuery | 店舗マスター |
| `jinjer.EMPLOYEES` | BigQuery | 従業員マスター |

---

## 3. アーキテクチャ

### 3.1 システム構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                        Google Cloud                              │
│  ┌───────────────┐                                              │
│  │   BigQuery    │                                              │
│  │  ┌─────────┐  │                                              │
│  │  │ SHOPS   │  │                                              │
│  │  │EMPLOYEES│  │                                              │
│  │  └─────────┘  │                                              │
│  └───────┬───────┘                                              │
│          │ SQL Query                                             │
│          ▼                                                       │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Google Apps Script (GAS)                      │  │
│  │  ┌─────────────────────┐  ┌─────────────────────────────┐ │  │
│  │  │ BigQuery to Sheets  │  │ リージョン別店舗選択        │ │  │
│  │  │    .gs              │  │        .gs                  │ │  │
│  │  │                     │  │                             │ │  │
│  │  │ - dataKoushin()     │  │ - formKoushin()             │ │  │
│  │  │ - tenpoListSakusei()│  │ - dataYomikomi()            │ │  │
│  │  │ - userListSakusei() │  │ - regionChuushutsu()        │ │  │
│  │  └──────────┬──────────┘  └──────────────┬──────────────┘ │  │
│  └─────────────┼────────────────────────────┼────────────────┘  │
│                │                            │                    │
│                ▼                            ▼                    │
│  ┌─────────────────────┐      ┌─────────────────────┐          │
│  │  Google Sheets      │      │   Google Forms      │          │
│  │  ┌───────────────┐  │      │  ┌───────────────┐  │          │
│  │  │ 店舗リスト    │  │─────▶│  │ 従業員選択    │  │          │
│  │  │ ユーザーリスト│  │      │  │ 店舗選択      │  │          │
│  │  │ リージョン別  │  │      │  │ リージョン別  │  │          │
│  │  └───────────────┘  │      │  └───────────────┘  │          │
│  └─────────────────────┘      └─────────────────────┘          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 データフロー

```
[BigQuery]
    │
    │ 1. SQL Query (店舗/ユーザー取得)
    ▼
[GAS: dataKoushin()]
    │
    │ 2. データ変換 & マージ処理
    │    - manual優先ロジック
    │    - リージョン正規化
    ▼
[Spreadsheet]
    │
    │ 3. シートからデータ読み込み
    ▼
[GAS: formKoushin()]
    │
    │ 4. フォーム更新
    │    - 選択肢生成
    │    - ナビゲーション設定
    ▼
[Google Forms]
```

---

## 4. ファイル構成

```
店舗不具合フォーム/
├── BigQuery to Sheets.gs      # データ取得・シート更新
├── リージョン別店舗選択.gs    # フォーム更新
└── Docs/
    ├── システム要件書.md
    ├── 技術仕様書.md          # 本ドキュメント
    └── 運用マニュアル_手動更新ガイド.md
```

---

## 5. 主要関数一覧

### 5.1 BigQuery to Sheets.gs

| 関数名 | 役割 | トリガー |
|--------|------|---------|
| `onOpen()` | カスタムメニュー作成 | スプレッドシート開封時 |
| `projectIdSettei()` | GCPプロジェクトID設定 | 初回のみ手動 |
| `dataKoushin()` | メインデータ更新処理 | 時間主導型トリガー |
| `tenpoListSakusei()` | 店舗リスト作成 | dataKoushin()から呼出 |
| `userListSakusei()` | ユーザーリスト作成 | dataKoushin()から呼出 |
| `regionSheetSakusei()` | リージョン別シート作成 | dataKoushin()から呼出 |
| `bigQueryJikkou()` | BigQueryクエリ実行 | 内部関数 |
| `showTenpoRegionDialog()` | 手動変更ダイアログ表示 | カスタムメニュー |
| `updateTenpoRegion()` | リージョン変更処理 | ダイアログから呼出 |
| `updateFormAfterRegionChange()` | フォーム更新（変更後） | ダイアログから呼出 |

### 5.2 リージョン別店舗選択.gs

| 関数名 | 役割 | トリガー |
|--------|------|---------|
| `setteiKakunin()` | 設定確認 | 手動 |
| `debugFormAccess()` | アクセス診断 | 手動 |
| `formKoushin()` | フォーム更新メイン | 時間主導型トリガー |
| `dataYomikomi()` | シートからデータ読込 | formKoushin()から呼出 |
| `regionChuushutsu()` | リージョン抽出 | 内部関数 |

---

## 6. データ仕様

### 6.1 店舗リストシート

| カラム | ヘッダー | 型 | 説明 |
|--------|---------|-----|------|
| A | 店舗コード | String | `CSW`プレフィックス |
| B | 店舗名 | String | 店舗正式名称 |
| C | リージョン | String | `A`〜`Z` または `Region X` |
| D | 店舗タイプ | String | 店舗種別 |
| E | ソース | String | `auto` / `manual` |

### 6.2 ユーザーリストシート

| カラム | ヘッダー | 型 | 説明 |
|--------|---------|-----|------|
| A (0) | id | String | 従業員ID |
| B (1) | firstName | String | 名 |
| C (2) | lastName | String | 姓 |
| U (20) | departmentName | String | 部署名（リージョン情報含む） |
| 最終列 | source | String | `auto` / `manual` |

### 6.3 マージロジック

```javascript
// 手動データの維持条件
if (source === 'manual') {
  const bqRegion = BigQueryから取得したリージョン;
  const manualRegion = 手動設定したリージョン;
  
  if (正規化(manualRegion) === 正規化(bqRegion)) {
    // BigQueryが追いついた → autoに切替
    return 'auto';
  } else {
    // まだ異なる → manualを維持
    return 'manual';
  }
}
```

---

## 7. SQL クエリ

### 7.1 店舗リスト取得

```sql
SELECT
  s1.code,
  name as shopName,
  s1.region,
  shop_type as shopType
FROM
  `exment.SHOPS` s1
WHERE brand = 'crisp'
  AND s1.code LIKE 'CSW%'
ORDER BY code
```

### 7.2 ユーザーリスト取得

```sql
SELECT * 
FROM `jinjer.EMPLOYEES`
WHERE enrollmentClassification = '在籍'
  AND REGEXP_CONTAINS(departmentName, r'^Region [A-Z]$')
  AND ID != '99998'
```

---

## 8. トリガー設定

### 8.1 推奨設定

| 関数 | タイプ | 時間 | 備考 |
|------|-------|------|------|
| `dataKoushin` | 時間主導型 | 毎日 02:00 | BigQueryデータ取得 |
| `formKoushin` | 時間主導型 | 毎日 02:05 | フォーム更新 |

### 8.2 設定方法

1. GASエディタで「トリガー」を開く
2. 「トリガーを追加」をクリック
3. 実行する関数を選択
4. イベントソース: 時間主導型
5. 時間ベースのトリガーのタイプ: 日付ベースのタイマー
6. 時刻を選択

---

## 9. エラーハンドリング

### 9.1 エラーケースと対応

| エラー | 原因 | 対応 |
|--------|------|------|
| GCPプロジェクトID未設定 | Script Properties が空 | `projectIdSettei()` を実行 |
| BigQuery接続エラー | 認証/権限問題 | OAuth再認証、IAM確認 |
| シートなしエラー | シートが削除された | シートを再作成 |
| フォームアクセスエラー | 権限不足/URL誤り | 編集URL使用、権限確認 |

### 9.2 ログ確認方法

```javascript
// 実行ログはGASエディタの「実行ログ」で確認
Logger.log('メッセージ');
```

---

## 10. セキュリティ

### 10.1 認証・認可

| 項目 | 方式 |
|------|------|
| GAS実行権限 | Google Account OAuth |
| BigQueryアクセス | Service Account / User認証 |
| フォーム編集 | Google Forms 共同編集者権限 |

### 10.2 データ保存

| データ | 保存先 | スコープ |
|--------|--------|---------|
| GCPプロジェクトID | Script Properties | プロジェクト全体 |
| 実行結果 | Script/User Properties | プロジェクト/ユーザー |

---

## 11. 制約事項

### 11.1 GAS制限

| 項目 | 制限値 |
|------|--------|
| 実行時間 | 6分 |
| トリガー実行時間 | 30分 |
| スクリプトサイズ | 50MB |

### 11.2 BigQuery制限

| 項目 | 制限値 |
|------|--------|
| クエリ実行時間 | 6分（GAS経由） |
| レスポンスサイズ | 制限あり（ページング対応済み） |

### 11.3 スプレッドシート制限

| 項目 | 制限値 |
|------|--------|
| セル数 | 約1000万セル |
| 行数 | 制限なし（セル数に依存） |

---

## 12. 開発環境

### 12.1 推奨ツール

| 用途 | ツール |
|------|--------|
| GAS開発 | clasp (CLI) |
| エディタ | VS Code + GAS拡張機能 |
| バージョン管理 | Git/GitHub |

### 12.2 デプロイ方法

```bash
# clasp を使用する場合
clasp push  # ローカル → GAS
clasp pull  # GAS → ローカル
```

---

## 13. 改訂履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2026-01-06 | 初版作成 |

