# 店舗不具合フォーム システム要件書

## 1. システム概要

### 1.1 システム名
**店舗不具合報告フォーム管理システム**

### 1.2 システム目的
店舗からの不具合報告を効率的に収集するため、リージョン別の店舗選択を動的に管理するGoogle Apps Script（GAS）システム。BigQueryからマスターデータを取得し、Google Formsの選択肢を自動更新する。

### 1.3 システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                      Google Workspace                        │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │ Google Forms │◄───│ Spreadsheet  │◄───│   BigQuery   │  │
│  │ (不具合報告) │    │ (マスター)   │    │  (データ)    │  │
│  └──────────────┘    └──────────────┘    └──────────────┘  │
│         ▲                   ▲                   ▲           │
│         │                   │                   │           │
│         └───────────────────┴───────────────────┘           │
│                    Google Apps Script                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 機能要件

### 2.1 データ取得機能（BigQuery to Sheets.gs）

#### 2.1.1 GCPプロジェクト設定
| 項目 | 内容 |
|------|------|
| 関数名 | `projectIdSettei()` |
| 目的 | BigQueryへのアクセスに必要なGCPプロジェクトIDを設定 |
| 保存先 | Script Properties（`BQ_PROJECT_ID`） |
| 実行タイミング | 初回セットアップ時のみ |

#### 2.1.2 データ更新メイン処理
| 項目 | 内容 |
|------|------|
| 関数名 | `dataKoushin()` |
| 目的 | BigQueryから店舗・ユーザーデータを取得しシートに反映 |
| 処理順序 | 1. 店舗リスト取得 → 2. ユーザーリスト取得 → 3. リージョン別シート作成 |

#### 2.1.3 店舗リスト取得
| 項目 | 内容 |
|------|------|
| 関数名 | `tenpoListSakusei()` |
| データソース | `exment.SHOPS` テーブル |
| フィルタ条件 | `brand = 'crisp'` かつ `code LIKE 'CSW%'` |
| 出力シート | `店舗リスト` |
| 出力カラム | 店舗コード / 店舗名 / リージョン / 店舗タイプ |

#### 2.1.4 ユーザーリスト取得
| 項目 | 内容 |
|------|------|
| 関数名 | `userListSakusei()` |
| データソース | `jinjer.EMPLOYEES` テーブル |
| フィルタ条件 | `enrollmentClassification = '在籍'` かつ `Region [A-Z]` パターンに所属（動的対応） |
| 出力シート | `ユーザーリスト` |
| 出力カラム | 全カラム（動的） |

#### 2.1.5 リージョン別シート作成
| 項目 | 内容 |
|------|------|
| 関数名 | `regionSheetSakusei()` |
| 目的 | ユーザーごとに担当店舗一覧シートを作成 |
| シート命名規則 | `{フルネーム} {リージョンアルファベット}` |
| 出力カラム | 担当者 / 対象店舗 |

---

### 2.2 フォーム更新機能（リージョン別店舗選択.gs）

#### 2.2.1 設定確認
| 項目 | 内容 |
|------|------|
| 関数名 | `setteiKakunin()` |
| 目的 | フォームへのアクセス権限・設定状況を確認 |
| 出力 | フォームID / 名称 / 公開URL / 編集URL |

#### 2.2.2 アクセス診断
| 項目 | 内容 |
|------|------|
| 関数名 | `debugFormAccess()` |
| 目的 | フォームアクセス失敗時のトラブルシューティング |
| 診断内容 | 実行ユーザー / DriveApp権限 / FormApp権限 |

#### 2.2.3 フォーム更新メイン処理
| 項目 | 内容 |
|------|------|
| 関数名 | `formKoushin()` |
| 目的 | フォームの設問と選択肢を最新データで更新 |

**処理フロー：**
1. フォーム設定の適用（確認メッセージ、回答編集可否など）
2. スプレッドシートから従業員・店舗データを読み込み
3. 従業員設問の更新（リージョン別セクション遷移を設定）
4. 不足しているリージョンセクションを自動作成
5. 各リージョンの店舗選択肢を更新
6. 「報告内容の作成」セクションを末尾へ移動
7. ナビゲーション設定を統一

#### 2.2.4 フォーム設定オプション
| 設定項目 | デフォルト値 | 説明 |
|----------|-------------|------|
| `confirmationMessage` | `'回答ありがとうございました。'` | 送信完了メッセージ |
| `acceptingResponses` | `true` | 回答受付中 |
| `allowResponseEdits` | `false` | 回答編集不可 |
| `showLinkToRespondAgain` | `false` | 再回答リンク非表示 |
| `progressBar` | `false` | 進捗バー非表示 |
| `shuffleQuestions` | `false` | 設問順序固定 |

---

## 3. データ仕様

### 3.1 店舗リストシート構造
| カラム | ヘッダー名 | データ型 | 説明 |
|--------|-----------|---------|------|
| A列 | 店舗コード | String | `CSW`で始まる店舗識別子 |
| B列 | 店舗名 | String | 店舗の正式名称 |
| C列 | リージョン | String | `Region A` 〜 `Region E` |
| D列 | 店舗タイプ | String | 店舗の種別 |

### 3.2 ユーザーリストシート構造（主要カラム）
| カラム | ヘッダー名 | データ型 | 説明 |
|--------|-----------|---------|------|
| A列(0) | ID | String | 従業員ID |
| B列(1) | 姓 | String | 従業員の姓 |
| C列(2) | 名 | String | 従業員の名 |
| U列(20) | 部署名 | String | リージョン情報を含む部署名 |

### 3.3 店舗ラベル生成ルール
店舗選択肢の表示ラベルは以下の順序で結合：
```javascript
const STORE_LABEL_ORDER = ['name', 'code', 'area', 'address', 'phone'];
const STORE_LABEL_SEPARATOR = '｜';
```

**例：** `店舗名｜店舗コード｜エリア｜住所｜電話番号`

### 3.4 リージョン抽出ロジック
部署名からリージョンを抽出するパターン：
- `Region A` 〜 `Region E`（正規表現: `/Region[\s:-]*([A-Z])/i`）
- `リージョン A` 〜 `リージョン E`（正規表現: `/リージョン[\s:-]*([A-Z])/i`）

---

## 4. 非機能要件

### 4.1 セキュリティ要件
| 項目 | 要件 |
|------|------|
| フォームアクセス | 編集URLまたはIDによるアクセス（viewformは不可） |
| 権限 | フォームの共同編集者権限が必要 |
| プロパティ保存 | Script Properties / User Properties に実行結果を保存 |

### 4.2 エラーハンドリング
| ケース | 対応 |
|--------|------|
| ユーザーリストシートなし | エラーメッセージを表示して処理中断 |
| 店舗リストシートなし | エラーメッセージを表示して処理中断 |
| データが0件 | エラーメッセージを表示して処理中断 |
| 店舗選択肢が0件 | プレースホルダー「（店舗データなし）」を表示 |
| BigQuery接続失敗 | エラーログを出力してスロー |

### 4.3 ログ出力
- 処理開始/完了メッセージ
- データ件数（従業員数、店舗数、リージョン数）
- フォーム更新状況（設問追加、選択肢更新など）
- 実行結果をProperties に保存（オプション）

---

## 5. 運用要件

### 5.1 初期セットアップ手順
1. GASプロジェクトを作成
2. `BigQuery to Sheets.gs` と `リージョン別店舗選択.gs` をデプロイ
3. `projectIdSettei()` を実行してGCPプロジェクトIDを設定
4. BigQuery APIを有効化
5. `KIZON_FORM_ID_OR_URL` に対象フォームのURLを設定

### 5.2 定期実行設定（推奨）
| 処理 | 推奨頻度 | トリガータイプ |
|------|---------|---------------|
| `dataKoushin()` | 日次（深夜） | 時間主導型 |
| `formKoushin()` | `dataKoushin()` 直後 | 時間主導型 |

### 5.3 手動実行手順
1. スプレッドシートを開く
2. 「拡張機能」→「Apps Script」を選択
3. 必要な関数を選択して実行
4. 実行ログを確認

---

## 6. 依存関係

### 6.1 Google サービス
| サービス | 用途 |
|---------|------|
| SpreadsheetApp | マスターデータの読み書き |
| FormApp | フォームの動的更新 |
| DriveApp | ファイルアクセス確認 |
| BigQuery | データソース |
| PropertiesService | 設定値・実行結果の保存 |

### 6.2 外部データソース
| テーブル | スキーマ | 用途 |
|---------|---------|------|
| `exment.SHOPS` | BigQuery | 店舗マスター |
| `jinjer.EMPLOYEES` | BigQuery | 従業員マスター |

---

## 7. 制約事項

### 7.1 技術的制約
- フォームのviewform URLからは編集不可（editURLが必須）
- BigQuery APIの実行時間制限（6分）
- スプレッドシートの行数制限（約1000万セル）

### 7.2 運用上の制約
- リージョンは `Region [A-Z]` パターンに動的対応（F, G等の追加も自動対応）
- ブランドは `crisp` のみ対象
- 店舗コードは `CSW` プレフィックス限定

---

## 8. 改訂履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|--------|
| 1.0 | 2026-01-06 | 初版作成 | - |

